<story-context id="5-1-settings-screen-foundation" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.1</storyId>
    <title>Settings Screen Foundation</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-1-settings-screen-foundation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>a settings screen accessible from the meal list</iWant>
    <soThat>I can configure app preferences and API credentials</soThat>
    <tasks>
      <task id="1" status="done">Documentation Research &amp; Technical Validation - Understand Android Preferences framework and Jetpack Compose integration patterns</task>
      <task id="2" status="pending">Create Settings Screen Route - Add Settings route to NavGraph.kt navigation graph</task>
      <task id="3" status="pending">Create SettingsScreen Composable - Implement Scaffold with TopAppBar titled "Settings"</task>
      <task id="4" status="pending">Implement Preference Categories - Create "API Configuration", "Appearance", "About" category headers</task>
      <task id="5" status="pending">Add Toolbar Menu Item to Meal List - Modify MealListScreen.kt to add Settings menu item</task>
      <task id="6" status="pending">Create SettingsViewModel - Manage settings state and user interactions</task>
      <task id="7" status="pending">Create PreferencesRepository - Domain layer abstraction over SharedPreferences</task>
      <task id="8" status="pending">Create SettingsState Data Model - Define SettingsState data class with preference values</task>
      <task id="9" status="pending">Implement Preference Persistence - Use SharedPreferences.Editor for saving preferences</task>
      <task id="10" status="pending">Create Hilt Module for Preferences - Provide SharedPreferences singleton in AppModule.kt</task>
      <task id="11" status="pending">Unit Tests for SettingsViewModel - Test state management and preference coordination</task>
      <task id="12" status="pending">Unit Tests for PreferencesRepository - Test preference retrieval, saving, and reactive Flow</task>
      <task id="13" status="pending">Instrumentation Tests for Settings Navigation - Test navigation from meal list to settings and back</task>
      <task id="14" status="pending">Documentation and Architecture Alignment - Add KDoc comments and update architecture.md</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Settings screen is displayed with organized preference categories</criterion>
    <criterion id="2">Settings screen is accessible via toolbar menu item from the meal list screen</criterion>
    <criterion id="3">Preference categories include: "API Configuration", "Appearance", "About"</criterion>
    <criterion id="4">Navigation flows correctly: Meal List → Settings → Back to Meal List</criterion>
    <criterion id="5">Settings screen uses Android PreferenceScreen framework for automatic UI binding</criterion>
    <criterion id="6">Preference values are persisted using Android SharedPreferences</criterion>
    <criterion id="7">Settings screen displays current preference values when opened</criterion>
    <criterion id="8">Changes to preferences are saved immediately and reflected in the UI</criterion>
    <criterion id="9">Settings screen follows Material Design 3 patterns consistent with the rest of the app</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-5.md" title="Epic 5 Technical Specification" section="Settings Screen Foundation">
        Establishes settings screen infrastructure using Jetpack Compose with organized preference categories (API Configuration, Appearance, About). Defines navigation integration, state management via SettingsViewModel, and SharedPreferences persistence through PreferencesRepository abstraction. Foundation for Epic 5 stories: Story 5.2 (API credentials), Story 5.3 (model selection), Story 5.4 (dark mode).
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure - UI Layer">
        Defines MVVM architecture with ViewModel + StateFlow pattern for reactive UI updates. Settings follows established patterns: SettingsScreen (Composable) → SettingsViewModel (StateFlow&lt;SettingsState&gt;) → PreferencesRepository (Flow&lt;Preferences&gt;) → SharedPreferences. All screens use Jetpack Compose with Material Design 3 theming from ui/theme/Theme.kt.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Navigation">
        Navigation uses Jetpack Navigation Compose with type-safe routes. NavGraph.kt defines all navigation routes with animation transitions. Settings route follows established pattern: define route constant, add composable entry with slide transitions, configure back button navigation.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Dependency Injection">
        Hilt provides dependency injection across all layers. Modules defined in di/ package: AppModule (app-level dependencies), NetworkModule (Retrofit, OkHttp), RepositoryModule (repository bindings). Settings requires SharedPreferences singleton in AppModule and PreferencesRepository binding.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 5.1: Settings Screen Foundation">
        Settings screen accessible from meal list via toolbar menu item. Uses Android PreferenceScreen framework with preference categories. Preference values persisted using SharedPreferences. Navigation: Meal List → Settings → Back. Foundation for future stories: API configuration (5.2), model selection (5.3), theme preference (5.4).
      </doc>
      <doc path="docs/stories/4-7-persistent-notification-with-manual-retry.md" title="Story 4.7 Completion Notes" section="Dev Agent Record">
        Previous story (4.7) fully implemented during Story 4.3 bug fixes. Created util/NotificationHelper.kt for centralized notification management - consider similar pattern for Settings utilities. BroadcastReceiver registered in AndroidManifest with exported=false security pattern. Manual testing critical for UX validation on physical devices.
      </doc>
    </docs>

    <code>
      <artifact path="app/src/main/java/com/foodie/app/ui/screens/settings/SettingsScreen.kt" kind="composable" symbol="SettingsScreen" lines="39-89" reason="Existing placeholder Settings screen from Story 1.3. Currently displays placeholder text. Needs enhancement with preference categories, list items, and Material Design 3 components for Epic 5 requirements."/>
      <artifact path="app/src/main/java/com/foodie/app/ui/navigation/NavGraph.kt" kind="navigation" symbol="NavGraph" lines="210-228" reason="Navigation graph with Settings route already defined. Settings route uses slide transitions. Pattern to follow for any additional navigation requirements."/>
      <artifact path="app/src/main/java/com/foodie/app/ui/screens/meallist/MealListScreen.kt" kind="composable" symbol="MealListScreen" reason="Meal list screen where Settings menu item needs to be added to TopAppBar actions. Follow existing IconButton pattern for toolbar actions."/>
      <artifact path="app/src/main/java/com/foodie/app/ui/theme/Theme.kt" kind="theme" symbol="FoodieTheme" reason="Material Design 3 theme definition. Settings screen must use consistent theming with MaterialTheme.colorScheme and typography from this theme."/>
      <artifact path="app/src/main/java/com/foodie/app/data/local/preferences/SecurePreferences.kt" kind="data_source" symbol="SecurePreferences" reason="Existing secure preferences interface using BuildConfig (temporary approach from Story 2.4). Story 5.1 creates standard SharedPreferences infrastructure, Story 5.2 migrates to EncryptedSharedPreferences for API key storage."/>
      <artifact path="app/src/main/java/com/foodie/app/MainActivity.kt" kind="activity" symbol="MainActivity" lines="49" reason="Example of SharedPreferences usage: getSharedPreferences('foodie_prefs', MODE_PRIVATE). Use same preference name for consistency."/>
      <artifact path="app/src/androidTest/java/com/foodie/app/ui/screens/settings/SettingsScreenTest.kt" kind="test" symbol="SettingsScreenTest" reason="Existing instrumentation tests for Settings screen placeholder. Tests verify TopAppBar title, back button. Extend with tests for preference categories, navigation flow."/>
      <artifact path="app/src/androidTest/java/com/foodie/app/ui/screens/meallist/MealListScreenTest.kt" kind="test" symbol="MealListScreenTest" lines="27,44,49" reason="Example instrumentation test using composeTestRule.setContent, onNodeWithText, assertIsDisplayed. Follow same pattern for Settings navigation tests."/>
      <artifact path="app/src/test/java/com/foodie/app/ui/screens/mealdetail/MealDetailViewModelTest.kt" kind="test" symbol="MealDetailViewModelTest" reason="Example ViewModel unit test pattern using MockK, runTest, StateFlow assertions. Follow for SettingsViewModel tests."/>
    </code>

    <dependencies>
      <kotlin version="2.2.21">
        <kotlinx-coroutines-android version="1.9.0"/>
        <kotlinx-coroutines-test version="1.9.0"/>
      </kotlin>
      <androidx>
        <compose-bom version="2024.10.01"/>
        <compose-ui/>
        <compose-material3/>
        <navigation-compose version="2.8.4"/>
        <lifecycle-viewmodel-compose version="2.8.7"/>
        <lifecycle-runtime-compose version="2.8.7"/>
        <hilt-navigation-compose version="1.2.0"/>
        <security-crypto version="1.1.0-alpha06" note="For EncryptedSharedPreferences in Story 5.2"/>
      </androidx>
      <hilt>
        <hilt-android version="2.51.1"/>
        <hilt-android-compiler version="2.51.1"/>
      </hilt>
      <testing>
        <junit version="4.13.2"/>
        <mockito-core version="5.14.2"/>
        <mockito-kotlin version="5.4.0"/>
        <truth version="1.4.4"/>
        <androidx-test-ext-junit version="1.2.1"/>
        <androidx-compose-ui-test-junit4/>
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
    <architectural>
      <pattern>MVVM architecture required: SettingsScreen (Composable) → SettingsViewModel (StateFlow) → PreferencesRepository (abstraction) → SharedPreferences (Android framework)</pattern>
      <pattern>All ViewModels must be lifecycle-aware, use Hilt @HiltViewModel annotation, and expose StateFlow for reactive UI updates</pattern>
      <pattern>Repository pattern required: Create interface PreferencesRepository with implementation PreferencesRepositoryImpl, bind in Hilt RepositoryModule</pattern>
      <pattern>Compose-first architecture: Use Jetpack Compose for all UI, avoid XML layouts except where Android framework requires (e.g., AndroidManifest)</pattern>
      <pattern>Material Design 3 consistency: Use MaterialTheme.colorScheme, typography, spacing from ui/theme/Theme.kt across all UI components</pattern>
    </architectural>
    <coding>
      <standard>Use KDoc comments for all public APIs (functions, classes, interfaces). Include @param, @return, @throws tags where applicable.</standard>
      <standard>Follow Kotlin coding conventions: prefer immutable data (val over var), use data classes for state models, leverage null safety</standard>
      <standard>Coroutines: Use viewModelScope for ViewModel coroutines, structured concurrency with try-catch for error handling</standard>
      <standard>Testing: Unit tests for ViewModels and Repositories using MockK, runTest. Instrumentation tests for UI using composeTestRule.</standard>
      <standard>Naming convention for preferences: Prefix all SharedPreferences keys with "pref_", use snake_case (e.g., "pref_azure_endpoint", "pref_theme_mode")</standard>
    </coding>
    <testing>
      <requirement>Unit tests required for SettingsViewModel (state management, preference load/save) and PreferencesRepository (CRUD operations, reactive Flow)</requirement>
      <requirement>Instrumentation tests required for Settings navigation flow (meal list → settings → back), settings UI rendering (categories displayed)</requirement>
      <requirement>Test naming: Use backtick syntax for readable test names: `methodName_whenCondition_thenExpectedResult` or `feature should behavior when condition`</requirement>
      <requirement>Use Truth library for assertions: assertThat(x).isEqualTo(y), assertThat(list).containsExactly(...)</requirement>
      <requirement>Mock dependencies using MockK: mockk&lt;PreferencesRepository&gt;(), every { ... } returns ..., verify { ... }</requirement>
    </testing>
    <security>
      <rule>Standard SharedPreferences for non-sensitive preferences (endpoint URL, model name, theme). EncryptedSharedPreferences for API key (Story 5.2).</rule>
      <rule>Never log sensitive data (API keys). Use masked display in UI (e.g., "API Key•••••" for API key preview).</rule>
    </security>
  </constraints>

  <interfaces>
    <interface name="PreferencesRepository" kind="repository_interface" signature="
interface PreferencesRepository {
    // Preference CRUD
    suspend fun getString(key: String, defaultValue: String = &quot;&quot;): String
    suspend fun setString(key: String, value: String): Result&lt;Unit&gt;
    suspend fun getBoolean(key: String, defaultValue: Boolean = false): Boolean
    suspend fun setBoolean(key: String, value: Boolean): Result&lt;Unit&gt;

    // Reactive updates
    fun observePreferences(): Flow&lt;Map&lt;String, Any?&gt;&gt;
    fun observeString(key: String): Flow&lt;String?&gt;
    fun observeBoolean(key: String): Flow&lt;Boolean?&gt;

    // Clear all preferences (for testing/reset)
    suspend fun clearAll(): Result&lt;Unit&gt;
}
" path="app/src/main/java/com/foodie/app/data/repository/PreferencesRepository.kt"/>

    <interface name="SettingsState" kind="data_class" signature="
data class SettingsState(
    val isLoading: Boolean = false,
    val error: String? = null,
    // Placeholder fields for future preferences
    val apiEndpoint: String = &quot;&quot;,
    val modelName: String = &quot;gpt-4.1&quot;,
    val themeMode: String = &quot;system&quot; // system|light|dark
)
" path="app/src/main/java/com/foodie/app/ui/screens/settings/SettingsState.kt"/>

    <interface name="NavGraph Settings Route" kind="navigation_route" signature="
composable(
    route = &quot;settings&quot;,
    enterTransition = { slideIntoContainer(SlideDirection.Left, tween(300)) },
    exitTransition = { slideOutOfContainer(SlideDirection.Right, tween(250)) }
) {
    SettingsScreen(
        onNavigateBack = { navController.popBackStack() }
    )
}
" path="app/src/main/java/com/foodie/app/ui/navigation/NavGraph.kt"/>

    <interface name="Hilt SharedPreferences Provider" kind="hilt_module" signature="
@Module
@InstallIn(SingletonComponent::class)
object AppModule {
    @Provides
    @Singleton
    fun provideSharedPreferences(@ApplicationContext context: Context): SharedPreferences {
        return context.getSharedPreferences(&quot;foodie_prefs&quot;, Context.MODE_PRIVATE)
    }
}
" path="app/src/main/java/com/foodie/app/di/AppModule.kt"/>
  </interfaces>

  <tests>
    <standards>
      Testing framework: JUnit 4.13.2 for unit tests, Compose UI Test for instrumentation tests. Use MockK for mocking dependencies. Truth library for assertions (assertThat syntax). Coroutine testing with kotlinx-coroutines-test (runTest, TestDispatcher). ViewModel tests: Mock repository, verify StateFlow emissions. Repository tests: Use fake SharedPreferences or in-memory implementation. UI tests: Use composeTestRule.setContent, onNodeWithText, assertIsDisplayed, performClick.
    </standards>

    <locations>
      <location>app/src/test/java/com/foodie/app/ui/screens/settings/SettingsViewModelTest.kt</location>
      <location>app/src/test/java/com/foodie/app/data/repository/PreferencesRepositoryTest.kt</location>
      <location>app/src/androidTest/java/com/foodie/app/ui/screens/settings/SettingsNavigationTest.kt</location>
    </locations>

    <ideas>
      <test ac="1,3,9" desc="SettingsScreen displays preference categories with correct Material Design 3 styling">
        Unit test: Verify SettingsScreen composable renders LazyColumn with three category headers ("API Configuration", "Appearance", "About"). Assert Material Typography styles applied. Use composeTestRule.onNodeWithText to find category headers.
      </test>
      <test ac="2,4" desc="Settings menu item navigates to Settings screen and back button returns">
        Instrumentation test: Launch MealListScreen, tap Settings menu item (IconButton with Settings icon), verify SettingsScreen displayed. Tap back arrow, verify MealListScreen restored. Use NavController test double to verify navigation calls.
      </test>
      <test ac="6,7,8" desc="PreferencesRepository persists and retrieves preference values reactively">
        Unit test: Mock SharedPreferences, call repository.setString("pref_test", "value"), verify SharedPreferences.Editor.apply() called. Call repository.getString("pref_test"), assert returns "value". Test observeString Flow emits updates when preference changes.
      </test>
      <test ac="7,8" desc="SettingsViewModel loads preferences on init and updates StateFlow on changes">
        Unit test: Mock PreferencesRepository, initialize SettingsViewModel, verify repository.observePreferences() called. Emit preference update from repository Flow, assert SettingsViewModel StateFlow updated with new values. Use Turbine or collectValues for Flow testing.
      </test>
      <test ac="6,8" desc="Preference changes save immediately and persist across app restarts">
        Integration test: Set preference value, kill app process, restart app, verify preference value persisted. Requires instrumentation test with ActivityScenario recreation.
      </test>
    </ideas>
  </tests>
</story-context>
