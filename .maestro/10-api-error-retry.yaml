# Story 4.3 E2E Test: API Error Retry
# Tests API error handling and retry mechanism
#
# Acceptance Criteria Validated:
# - API failure shows user-friendly notification
# - Failed job saved to WorkManager queue
# - User can retry from notification
# - Retry succeeds with correct API config
#
# NOTE: This test requires MANUAL EXECUTION due to:
# - Widget-based meal capture (cannot automate widget interaction)
# - Notification interaction (requires system-level permissions)
# - WorkManager background jobs (timing-dependent)
#
# MANUAL TEST STEPS:
# ============================================

appId: com.foodie.app
---
# 1. Configure invalid API credentials
- launchApp:
    clearState: false

- runFlow: flows/dismiss-onboarding.yaml

- runFlow: flows/open-settings.yaml

# Set invalid API key to force failure
- tapOn: "API Key"
- inputText: "invalid-key-for-testing"

- tapOn: "Endpoint"
- inputText: "https://invalid.endpoint.test"

# Navigate back (auto-saves)
- pressKey: BACK

# ============================================
# 2. MANUAL STEP: Use widget to capture meal photo
# ============================================
# - Exit app to home screen
# - Use Foodie widget to capture photo
# - Wait for background job to fail

# ============================================
# 3. MANUAL STEP: Verify error notification
# ============================================
# - Pull down notification shade
# - Verify notification shows user-friendly error message
# - Notification should have "Tap to retry" or similar action

# ============================================
# 4. Fix API Configuration
# ============================================

- launchApp

- runFlow: flows/open-settings.yaml

# Enter valid API credentials
- tapOn: "API Key"
- eraseText
- inputText: "valid-test-key-placeholder"

- tapOn: "Endpoint"
- eraseText
- inputText: "https://test.openai.azure.com"

# Navigate back (auto-saves)
- pressKey: BACK

# ============================================
# 5. MANUAL STEP: Trigger retry from notification
# ============================================
# - Pull down notification shade
# - Tap on retry notification
# - Wait for background job to complete
# - Verify success notification appears

# ============================================
# 6. Verify meal appears in list
# ============================================

# Navigate to Meals tab
- tapOn: "Meals"

# Meal should appear after successful retry
- assertVisible:
    text: "\\d+\\s*kcal"

# ============================================
# CLEANUP
# ============================================

# Clear test API credentials
- runFlow: flows/open-settings.yaml

- tapOn: "API Key"
- eraseText

- tapOn: "Endpoint"
- eraseText

- pressKey: BACK

# ============================================
# SUCCESS CRITERIA
# ============================================
# ✅ API failure triggered error notification
# ✅ Notification was user-friendly
# ✅ Failed job queued in WorkManager
# ✅ Retry succeeded with valid config
# ✅ Meal appeared after successful retry
