# Story 2.7 E2E Test: Complete Capture Flow
# Tests meal capture via widget and photo confirmation flow
#
# Acceptance Criteria Validated:
# - AC2: Photo capture + confirmation works
# - AC3: User can return immediately after confirmation
# - AC5: Meal data can be verified in meal list
#
# NOTE: AC1 (widget launch timing) requires manual testing with adb logcat
# NOTE: AC4,6,7,8,9 require instrumentation tests or manual validation

appId: com.foodie.app
---
# Launch app
- launchApp:
    clearState: false

# Dismiss onboarding if present
- runFlow: flows/dismiss-onboarding.yaml

# Grant Health Connect permissions if dialog appears
- tapOn:
    text: "Allow"
    optional: true

# ============================================
# Meal Capture Flow
# ============================================
# NOTE: This test requires:
# 1. Widget configured on home screen
# 2. Manual photo capture (system camera)
# 3. Manual execution - cannot be fully automated
#
# Steps:
# 1. Exit to home screen
# 2. Tap widget to launch camera
# 3. Take photo
# 4. Confirm photo
# 5. Return to app
# 6. Verify meal appears in list

# ============================================
# PHASE 3: Camera Screen Validation
# ============================================

# Verify camera screen appeared
# Note: System camera intent cannot be controlled by Maestro
# This test assumes you're using custom camera UI or mock mode

- assertVisible:
    text: "Tap to capture"
    timeout: 1000

# If using system camera (real device), manually take photo
# If using custom camera UI:
- tapOn:
    id: "capture_button"
    optional: true

# ============================================
# PHASE 4: Photo Confirmation (< 5s total target)
# ============================================

# Wait for photo preview screen
- assertVisible:
    text: "Use Photo"
    timeout: 3000

# Verify visual checkmark appears (AC9)
# Note: Animation may be brief - use optional
- assertVisible:
    id: "checkmark_icon"
    optional: true

# Confirm photo
- tapOn: "Use Photo"

# ============================================
# PHASE 5: Background Processing (< 15s target)
# ============================================

# User should return to meal list immediately (AC3)
- assertVisible:
    text: "Meal List"
    timeout: 2000

# Wait for background WorkManager job to complete
# Processing: Photo → API → Parsing → Health Connect save
# Note: This may take 5-20 seconds depending on API latency

- waitForAnimationToEnd:
    timeout: 20000

# ============================================
# PHASE 6: Verify Meal Appears (AC5)
# ============================================

# Pull to refresh to ensure latest data from Health Connect
- swipe:
    direction: DOWN
    duration: 500

- waitForAnimationToEnd

# Meal should appear in list (proves HC save succeeded)
# Note: Actual meal description depends on AI analysis
# Look for any item with "kcal" (calorie value)
- assertVisible:
    text: ".*kcal.*"
    timeout: 5000

# ============================================
# PHASE 7: Verify Data Persistence
# ============================================

# Background app and return (verify data persists)
- pressKey: HOME
- launchApp:
    appId: com.foodie.app

# Meal should still be visible
- assertVisible:
    text: ".*kcal.*"

# ============================================
# SUCCESS CRITERIA
# ============================================

# ✅ Test passes if:
# 1. Camera launched from app
# 2. Photo confirmed
# 3. User returned to meal list
# 4. Meal appeared within 20s
# 5. Data persisted after backgrounding

# ⚠️ Manual validation required:
# - Widget launch timing (< 500ms) - measure with adb logcat
# - Haptic feedback (AC8) - only on physical device
# - Photo deletion (AC6) - check with Device File Explorer
# - Actual analysis accuracy - verify with real food photos

# ============================================
# CLEANUP (Optional)
# ============================================

# Delete test meal to keep HC clean
# Note: This requires navigating to the meal and deleting
# Skip for now to avoid test brittleness

# - tapOn: ".*kcal.*"
# - tapOn: "Delete"
# - tapOn: "Confirm"
