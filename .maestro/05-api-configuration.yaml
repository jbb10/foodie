# Story 5.2/5.3 E2E Test: API Configuration
# Tests API settings configuration and persistence
#
# Acceptance Criteria Validated:
# - User can enter API key, endpoint, and model
# - Settings persist after app restart
# - Test connection validates configuration

appId: com.foodie.app
---
# Launch app
- launchApp:
    clearState: false

# Dismiss onboarding if present
- runFlow: flows/dismiss-onboarding.yaml

# Navigate to Settings
- runFlow: flows/open-settings.yaml

# ============================================
# Configure API Settings
# ============================================

# Tap API Key field
- tapOn: "API Key"

# Enter test API key
- inputText: "test-api-key-e2e"

# Tap Endpoint field
- tapOn: "Endpoint"

# Enter test endpoint
- inputText: "https://test.openai.azure.com"

# Tap Model field
- tapOn: "Model"

# Enter model name
- inputText: "gpt-4o"

# ============================================
# Test Connection
# ============================================

# Scroll to test button
- scroll

# Tap Test Connection
- tapOn: "Test Connection"

# Wait for result
# NOTE: With fake credentials this will fail
- assertVisible:
    text: "(Connection|Error|Success|Invalid|Failed)"

# ============================================
# Save Configuration
# ============================================

# Navigate back (auto-saves)
- pressKey: BACK

# ============================================
# Verify Persistence
# ============================================

# Return to settings
- runFlow: flows/open-settings.yaml

# Verify endpoint is saved
- assertVisible: "test.openai.azure.com"

# Verify model is saved
- assertVisible: "gpt-4o"

# ============================================
# Verify After Restart
# ============================================

# Close settings
- pressKey: BACK

# Restart app
- pressKey: HOME
- stopApp
- launchApp

# Dismiss onboarding if present
- runFlow: flows/dismiss-onboarding.yaml

# Navigate to settings
- runFlow: flows/open-settings.yaml

# Settings should still be present
- assertVisible: "test.openai.azure.com"
- assertVisible: "gpt-4o"

# ============================================
# CLEANUP: Clear test configuration
# ============================================

# Clear API key
- tapOn: "API Key"
- eraseText

# Clear endpoint
- tapOn: "Endpoint"
- eraseText

# Clear model (optional)
- tapOn: "Model"
- eraseText

# Navigate back (auto-saves)
- pressKey: BACK

# ============================================
# SUCCESS CRITERIA
# ============================================

# ✅ Test passes if:
# 1. Settings screen accessible
# 2. API fields editable
# 3. Test connection executed (result doesn't matter)
# 4. Settings saved successfully
# 5. Settings persisted after restart
# 6. Cleanup successful

# ⚠️ Manual validation required:
# - Verify API key encrypted in preferences
# - Test with real API credentials
# - Verify photo capture uses new config
